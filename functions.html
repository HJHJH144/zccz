<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zc和lcz的功能中心</title>
    <!-- PWA相关 -->
    <meta name="theme-color" content="#141e30">
    <meta name="description" content="zc和lcz的专属功能中心">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="android-launchericon-192-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background: linear-gradient(135deg, #141e30, #243b55);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #ff758c, #ff7eb3);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 5px 15px rgba(255, 117, 140, 0.4);
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .func-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 20px;
            border-radius: 30px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
        }

        .func-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }

        .func-button svg {
            margin-right: 10px;
        }

        #memoryBtn {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
        }

        #musicBtn {
            background: linear-gradient(45deg, #11998e, #38ef7d);
        }

        #chatBtn {
            background: linear-gradient(45deg, #FF0000, #FF8000);
            border: 3px solid rgba(255, 255, 0, 0.5);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 128, 0, 0.6);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 128, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 128, 0, 0);
            }
        }

        .return-link {
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .return-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* 密码验证层 */
        #passwordLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .password-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            width: 350px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 117, 140, 0.3);
        }

        .password-title {
            margin-bottom: 20px;
            color: white;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #chatPassword {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 30px;
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
        }

        #passwordError {
            color: #ff5555;
            font-size: 14px;
            margin-bottom: 15px;
            display: none;
        }

        #unlockBtn {
            background: linear-gradient(45deg, #ff758c, #ff7eb3);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>zc和lcz的功能中心</h1>
        <div class="button-container">
            <a href="memory.html" id="memoryBtn" class="func-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                    <path d="M3 3v5h5"></path>
                </svg>
                重新浏览爱情故事
            </a>
            <a href="music.html" id="musicBtn" class="func-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
                选择爱情背景音乐
            </a>
            <button id="chatBtn" class="func-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                    </path>
                </svg>
                进入情侣聊天室
            </button>
        </div>
        <a href="index.html" class="return-link">返回爱情小窝</a>
    </div>

    <!-- 密码验证层 -->
    <div id="passwordLayer" style="display: none;">
        <div class="password-container">
            <h3 class="password-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="margin-right: 10px;">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                请输入密码解锁聊天
            </h3>
            <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 20px;">这将用于加密你们的聊天内容，请记住这个密码</p>
            <div style="position: relative; margin-bottom: 15px;">
                <input type="password" id="chatPassword" placeholder="输入你们的专属密码">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.7);">
                    <path
                        d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4">
                    </path>
                </svg>
            </div>
            <div id="passwordError" style="color: #ff5555; font-size: 14px; margin-bottom: 15px; display: none;">
                密码不正确，请重试
            </div>
            <button id="unlockBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="margin-right: 8px;">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                解锁聊天
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- 添加CryptoJS库用于加密 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyD8Iwxm9wECPAA_wey6vCPeGFz_USv8-JI",
            authDomain: "zc-lcz-love-chat.firebaseapp.com",
            databaseURL: "https://zc-lcz-love-chat-default-rtdb.firebaseio.com",
            projectId: "zc-lcz-love-chat",
            storageBucket: "zc-lcz-love-chat.appspot.com",
            messagingSenderId: "404788494356",
            appId: "1:404788494356:web:b2e8a8a04f9d25fdcb2cc1"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const messagesRef = database.ref('messages');
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 获取元素
            const chatBtn = document.getElementById('chatBtn');
            const passwordLayer = document.getElementById('passwordLayer');
            const chatPassword = document.getElementById('chatPassword');
            const unlockBtn = document.getElementById('unlockBtn');
            const passwordError = document.getElementById('passwordError');

            // 全局密码存储相关常量
            const STORAGE_PREFIX = "lcz_zc_secure_";
            const LOCAL_PASSWORD_KEY = STORAGE_PREFIX + "pwd_hash";
            const LOCAL_SALT_KEY = STORAGE_PREFIX + "salt";
            const LOCAL_VERIFICATION_KEY = STORAGE_PREFIX + "verification";
            const GLOBAL_PASSWORD_ID = STORAGE_PREFIX + "global_pwd_id";
            const MESSAGES_PASSWORD_ID = STORAGE_PREFIX + "messages_pwd_id";

            // 获取或生成加密盐值
            let salt = localStorage.getItem(LOCAL_SALT_KEY);
            if (!salt) {
                // 生成随机盐值 (32字节)
                const randomArray = new Uint8Array(32);
                window.crypto.getRandomValues(randomArray);
                salt = Array.from(randomArray).map(b => b.toString(16).padStart(2, '0')).join('');
                localStorage.setItem(LOCAL_SALT_KEY, salt);
            }

            // 点击聊天按钮显示密码层
            chatBtn.addEventListener('click', function () {
                passwordLayer.style.display = 'flex';
            });

            // 增强版密码哈希函数 - 使用PBKDF2算法
            async function generateSecureHash(password, salt) {
                // 将密码和盐值转换为ArrayBuffer
                const encoder = new TextEncoder();
                const passwordData = encoder.encode(password);
                const saltData = encoder.encode(salt);

                // 使用密码导入密钥
                const passwordKey = await window.crypto.subtle.importKey(
                    'raw',
                    passwordData,
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits']
                );

                // 使用PBKDF2导出密钥位 (50,000次迭代，增加暴力破解难度)
                const derivedBits = await window.crypto.subtle.deriveBits(
                    {
                        name: 'PBKDF2',
                        salt: saltData,
                        iterations: 50000,
                        hash: 'SHA-256'
                    },
                    passwordKey,
                    256
                );

                // 转换为十六进制字符串
                const hashArray = Array.from(new Uint8Array(derivedBits));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // 生成验证字符串 - 用于验证密码是否正确
            async function generateVerificationString(password) {
                // 创建一个固定的验证文本
                const verificationText = "zc_loves_lcz_verified_2024";

                // 使用AES-GCM加密验证文本
                const encoder = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );

                // 派生AES-GCM使用的密钥
                const key = await window.crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: encoder.encode(salt),
                        iterations: 10000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );

                // 生成随机IV
                const iv = window.crypto.getRandomValues(new Uint8Array(12));

                // 加密验证文本
                const encryptedData = await window.crypto.subtle.encrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv
                    },
                    key,
                    encoder.encode(verificationText)
                );

                // 组合IV和加密数据
                const encryptedArray = new Uint8Array(iv.length + encryptedData.byteLength);
                encryptedArray.set(iv, 0);
                encryptedArray.set(new Uint8Array(encryptedData), iv.length);

                // 转换为Base64字符串
                return btoa(String.fromCharCode.apply(null, encryptedArray));
            }

            // 验证密码是否正确
            async function verifyPassword(password, storedVerification) {
                try {
                    // 解析Base64编码的验证字符串
                    const encryptedArray = new Uint8Array(
                        atob(storedVerification).split('').map(char => char.charCodeAt(0))
                    );

                    // 提取IV (前12字节)
                    const iv = encryptedArray.slice(0, 12);

                    // 提取加密数据
                    const encryptedData = encryptedArray.slice(12);

                    // 导入密钥材料
                    const encoder = new TextEncoder();
                    const keyMaterial = await window.crypto.subtle.importKey(
                        'raw',
                        encoder.encode(password),
                        { name: 'PBKDF2' },
                        false,
                        ['deriveBits', 'deriveKey']
                    );

                    // 派生解密用的密钥
                    const key = await window.crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: encoder.encode(salt),
                            iterations: 10000,
                            hash: 'SHA-256'
                        },
                        keyMaterial,
                        { name: 'AES-GCM', length: 256 },
                        false,
                        ['decrypt']
                    );

                    // 尝试解密
                    const decryptedData = await window.crypto.subtle.decrypt(
                        {
                            name: 'AES-GCM',
                            iv: iv
                        },
                        key,
                        encryptedData
                    );

                    // 检查解密结果
                    const decryptedText = new TextDecoder().decode(decryptedData);
                    return decryptedText === "zc_loves_lcz_verified_2024";
                } catch (error) {
                    console.error("验证失败:", error);
                    return false;
                }
            }

            // 生成密码ID，用于标识不同的密码和确定是否需要重置消息
            async function generatePasswordId(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
            }

            // 将密码保存到所有Storage区域
            function saveGlobalPassword(password, passwordId) {
                // 保存到localStorage
                localStorage.setItem(GLOBAL_PASSWORD_ID, passwordId);

                // 保存到sessionStorage (用于当前会话共享)
                sessionStorage.setItem(GLOBAL_PASSWORD_ID, passwordId);
                sessionStorage.setItem('current_password', password);

                // 设置全局变量
                window.globalPasswordId = passwordId;
                window.currentPassword = password;

                // 将密码ID保存到数据库以便同步
                database.ref('settings/globalPasswordId').set(passwordId);
            }

            // 处理解锁按钮点击
            unlockBtn.addEventListener('click', async function () {
                const password = chatPassword.value.trim();
                if (!password) {
                    passwordError.textContent = '请输入密码';
                    passwordError.style.display = 'block';
                    return;
                }

                try {
                    // 检查本地存储中是否有验证字符串
                    const storedVerification = localStorage.getItem(LOCAL_VERIFICATION_KEY);
                    const storedHash = localStorage.getItem(LOCAL_PASSWORD_KEY);

                    // 生成当前密码的ID
                    const currentPasswordId = await generatePasswordId(password);

                    // 如果没有存储的验证字符串，这是首次设置密码
                    if (!storedVerification || !storedHash) {
                        // 生成增强的密码哈希
                        const secureHash = await generateSecureHash(password, salt);

                        // 生成验证字符串
                        const verification = await generateVerificationString(password);

                        // 存储到本地
                        localStorage.setItem(LOCAL_PASSWORD_KEY, secureHash);
                        localStorage.setItem(LOCAL_VERIFICATION_KEY, verification);

                        // 设置全局密码
                        saveGlobalPassword(password, currentPasswordId);
                        localStorage.setItem(MESSAGES_PASSWORD_ID, currentPasswordId);

                        // 使用密码作为加密密钥
                        passwordLayer.style.display = 'none';

                        // 在Firebase中存储一个随机标识符（不是真正的密码哈希）
                        database.ref('settings/identifier').set(Math.random().toString(36).substring(2, 15));

                        // 成功后跳转到聊天页面
                        window.location.href = 'chat.html';
                    } else {
                        // 生成当前输入密码的哈希
                        const inputHash = await generateSecureHash(password, salt);

                        // 首先比较哈希值（快速检查）
                        if (inputHash === storedHash) {
                            // 再进行验证字符串验证（双重检查）
                            const isValid = await verifyPassword(password, storedVerification);

                            if (isValid) {
                                // 密码正确 - 检查是否与上次使用的密码相同
                                const storedPasswordId = localStorage.getItem(GLOBAL_PASSWORD_ID);
                                const messagesPasswordId = localStorage.getItem(MESSAGES_PASSWORD_ID);

                                // 更新全局密码
                                saveGlobalPassword(password, currentPasswordId);

                                // 检查是否需要重置消息
                                if (messagesPasswordId && messagesPasswordId !== currentPasswordId) {
                                    // 提示用户密码已更改，将清除所有消息
                                    if (confirm('检测到密码已更改。为确保安全，所有聊天记录将被清除。是否继续？')) {
                                        // 清除消息
                                        await messagesRef.remove();
                                        // 更新消息密码ID
                                        localStorage.setItem(MESSAGES_PASSWORD_ID, currentPasswordId);
                                    } else {
                                        // 用户取消，提示需要使用原密码
                                        passwordError.textContent = '请使用原密码登录或确认清除消息';
                                        passwordError.style.display = 'block';
                                        return;
                                    }
                                }

                                // 成功后跳转到聊天页面
                                window.location.href = 'chat.html';
                            } else {
                                // 验证失败
                                passwordError.textContent = '密码不正确，请重试';
                                passwordError.style.display = 'block';
                            }
                        } else {
                            // 密码错误
                            passwordError.textContent = '密码不正确，请重试';
                            passwordError.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error("密码处理过程中出错:", error);
                    passwordError.textContent = '系统错误，请重试';
                    passwordError.style.display = 'block';
                }
            });

            // 按回车键提交密码
            chatPassword.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    unlockBtn.click();
                }
            });

            // 尝试从会话存储中获取密码 (用于页面间共享)
            const sessionPassword = sessionStorage.getItem('current_password');
            if (sessionPassword) {
                chatPassword.value = sessionPassword;
            } else {
                // 如果没有会话密码，尝试从URL参数获取密码
                const urlParams = new URLSearchParams(window.location.search);
                const autoPassword = urlParams.get('p');
                if (autoPassword) {
                    chatPassword.value = autoPassword;
                    // 自动清除URL参数
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        });

        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker 注册成功:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker 注册失败:', error);
                    });
            });
        }
    </script>
</body>

</html>